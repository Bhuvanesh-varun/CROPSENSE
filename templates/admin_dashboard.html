{% extends "base.html" %}
{% set hide_navbar = True %}
{% set hide_footer = True %}
{% block title %}Admin Dashboard{% endblock %}

{% block content %}

<div class="dashboard-wrapper admin-wrapper">

    <!-- ========== SIDEBAR ========== -->
    <aside class="dashboard-sidebar admin-sidebar">

        <div class="sidebar-brand text-success fw-bold">
            CropSense Admin
        </div>

        <ul class="sidebar-menu">
            <li class="active" data-pane="dashboard">
                <a onclick="showPane('dashboard')">
                    <i class="bi bi-speedometer2"></i> Dashboard
                </a>
            </li>

            <li data-pane="users">
                <a onclick="showPane('users')">
                    <i class="bi bi-people"></i> Users
                </a>
            </li>

            <li data-pane="history">
                <a onclick="showPane('history')">
                    <i class="bi bi-clock-history"></i> User History
                </a>
            </li>

            <li class="mt-3">
                <a href="{{ url_for('index') }}">
                    <i class="bi bi-house"></i> Home
                </a>
            </li>

            <li>
                <a href="{{ url_for('recommendations') }}">
                    <i class="bi bi-cpu"></i> Our AI
                </a>
            </li>
        </ul>

        <div class="sidebar-footer">
            <a href="{{ url_for('logout') }}" class="text-danger">
                <i class="bi bi-box-arrow-right"></i> Logout
            </a>
        </div>

    </aside>

    <!-- ========== MAIN CONTENT ========== -->
    <main class="dashboard-content">

        <!-- HEADER -->
        <div class="dashboard-header">

            <div>
                <h3 class="fw-bold mb-1" id="pageTitle">Admin Dashboard</h3>
                <p class="text-muted mb-0">System overview & platform analytics</p>
            </div>

            <!-- PROFILE AVATAR -->
            <div class="dropdown">
                <button class="profile-avatar" data-bs-toggle="dropdown">
                    A
                </button>

                <ul class="dropdown-menu dropdown-menu-end shadow">
                    <li class="dropdown-header fw-semibold">Admin</li>
                    <li>
                        <a class="dropdown-item text-danger" href="{{ url_for('logout') }}">
                            Logout
                        </a>
                    </li>
                </ul>
            </div>

        </div>

        <!-- ================= DASHBOARD ================= -->
        <section id="dashboard" class="pane active">

            <div class="kpi-grid">
                <div class="kpi-card">
                    <span>Total Users</span>
                    <h2>{{ users|length }}</h2>
                </div>
                <div class="kpi-card">
                    <span>Total Predictions</span>
                    <h2>{{ logs|length }}</h2>
                </div>
                <div class="kpi-card">
                    <span>Subscribers</span>
                    <h2>{{ standard_users|length + premium_users|length }}</h2>
                </div>
                <div class="kpi-card">
                    <span>Free Users</span>
                    <h2>{{ free_users|length }}</h2>
                </div>
            </div>

            <div class="card mt-4">
                <h5 class="fw-semibold mb-3">User Subscription Distribution</h5>
                <canvas id="subscriptionChart"></canvas>
            </div>

        </section>

        <!-- ================= USERS ================= -->
        <section id="users" class="pane">

            <div class="card">
                <h5 class="fw-semibold mb-3">All Users</h5>

                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Plan</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for u in users %}
                        <tr>
                            <td>{{ u.name }}</td>
                            <td>{{ u.email }}</td>
                            <td>
                                <span class="role-pill {{ u.role }}">{{ u.role }}</span>
                            </td>
                            <td>{{ u.plan }}</td>
                            <td class="d-flex gap-2">
                                <form method="post" action="/admin/toggle_admin/{{ u.id }}">
                                    <button class="btn btn-sm btn-outline-success">
                                        {{ "Demote" if u.role == "admin" else "Promote" }}
                                    </button>
                                </form>
                                <form method="post" action="/admin/delete/{{ u.id }}">
                                    <button class="btn btn-sm btn-outline-danger">
                                        Delete
                                    </button>
                                </form>
                                <a href="/admin/user_history/{{ u.id }}" class="btn btn-sm btn-outline-primary">
                                    History
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

            </div>
        </section>

        <!-- ================= USER HISTORY ================= -->
        <section id="history" class="pane">

            <div class="card">
                <h5 class="fw-semibold mb-3">Select a User</h5>

                <div class="row g-4">
                    {% for u in users %}
                    <div class="col-lg-3 col-md-4 col-sm-6">
                        <a href="/admin/user_history/{{ u.id }}" class="history-user-card">
                            <strong>{{ u.name }}</strong>
                            <small class="text-muted">{{ u.email }}</small>
                        </a>
                    </div>
                    {% endfor %}
                </div>

            </div>
        </section>

    </main>
</div>

<!-- ================= STYLES ================= -->
<style>
    .admin-wrapper .dashboard-content {
        background: #f8fafc;
    }

    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
    }

    .kpi-card {
        background: white;
        padding: 20px;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, .05);
    }

    .admin-table {
        width: 100%;
        border-collapse: collapse;
    }

    .admin-table th,
    .admin-table td {
        padding: 14px;
        border-bottom: 1px solid #e5e7eb;
    }

    .role-pill {
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
    }

    .role-pill.admin {
        background: #dcfce7;
        color: #15803d;
    }

    .role-pill.user {
        background: #e5e7eb;
        color: #334155;
    }

    .history-user-card {
        display: block;
        padding: 16px;
        border-radius: 14px;
        background: #fff;
        box-shadow: 0 8px 20px rgba(0, 0, 0, .05);
        text-decoration: none;
        color: #000;
    }

    .history-user-card:hover {
        background: #f1f5f9;
    }

    /* === CORE PANE VISIBILITY FIX === */
    .pane {
        display: none;
    }

    .pane.active {
        display: block;
    }
</style>

<!-- ================= SCRIPT ================= -->
<script>
function showPane(id) {

  // Hide all panes
  document.querySelectorAll(".pane").forEach(p => {
    p.classList.remove("active");
  });

  // Show selected pane
  const pane = document.getElementById(id);
  if (pane) pane.classList.add("active");

  // Update sidebar active state
  document.querySelectorAll(".sidebar-menu li").forEach(li => {
    li.classList.remove("active");
  });

  const activeItem = document.querySelector(
    `.sidebar-menu li[data-pane="${id}"]`
  );
  if (activeItem) activeItem.classList.add("active");

  // Update page title
  const titleMap = {
    dashboard: "Admin Dashboard",
    users: "User Management",
    history: "User History"
  };

  document.getElementById("pageTitle").innerText =
    titleMap[id] || "Admin Dashboard";
}
</script>


{% endblock %}